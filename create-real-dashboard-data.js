// TEST ET INSERTION DE DONN√âES R√âELLES POUR LE DASHBOARD PARTICULIER
// √âlimine compl√®tement les donn√©es simul√©es en cr√©ant des donn√©es r√©elles

// Utilisation d'import dynamique pour Node.js
const { createClient } = require('@supabase/supabase-js');

const supabaseUrl = 'https://upqthvkkgmykydxrpupm.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwcXRodmtrZ215a3lkeHJwdXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2NjI0NjUsImV4cCI6MjA1MTIzODQ2NX0.vJqYfBxmK1vpfPdx7EkR-ZMLQFvAjfrfQZHJHRqCktM';

const supabase = createClient(supabaseUrl, supabaseAnonKey);

async function createRealDashboardData() {
    console.log('üéØ CR√âATION DE DONN√âES R√âELLES POUR LE DASHBOARD');
    
    try {
        // 1. Cr√©er les tables n√©cessaires (ex√©cuter le SQL)
        console.log('\nüìã √âtape 1: V√©rification des tables...');
        
        // V√©rifier si les tables existent
        const { data: tables, error: tablesError } = await supabase
            .from('information_schema.tables')
            .select('table_name')
            .eq('table_schema', 'public')
            .in('table_name', ['transactions', 'appointments', 'favorites', 'agents']);
        
        if (!tablesError) {
            const existingTables = tables.map(t => t.table_name);
            console.log('‚úÖ Tables existantes:', existingTables);
        }

        // 2. Cr√©er quelques agents si n√©cessaire
        console.log('\nüë• √âtape 2: Cr√©ation d\'agents...');
        const { data: agents, error: agentsError } = await supabase
            .from('agents')
            .upsert([
                {
                    name: 'Moussa Diallo',
                    email: 'moussa.diallo@teranga.sn',
                    phone: '+221 77 123 45 67',
                    specialties: ['R√©sidentiel', 'Commercial']
                },
                {
                    name: 'Fatou Sow',
                    email: 'fatou.sow@teranga.sn',
                    phone: '+221 76 987 65 43',
                    specialties: ['Terrain', 'Investissement']
                },
                {
                    name: 'Ousmane Kane',
                    email: 'ousmane.kane@teranga.sn',
                    phone: '+221 78 456 78 90',
                    specialties: ['Industriel', 'Rural']
                }
            ], { onConflict: 'email' })
            .select();

        if (agentsError) {
            console.error('‚ùå Erreur cr√©ation agents:', agentsError);
        } else {
            console.log('‚úÖ Agents cr√©√©s:', agents?.length || 0);
        }

        // 3. Obtenir un utilisateur test
        console.log('\nüë§ √âtape 3: Recherche d\'utilisateur test...');
        const { data: authUser, error: authError } = await supabase.auth.getUser();
        
        if (authError || !authUser.user) {
            console.log('‚ùå Aucun utilisateur connect√©. Connexion en cours...');
            
            // Tentative de connexion avec un compte test
            const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
                email: 'test@teranga.sn',
                password: 'testpassword123'
            });
            
            if (signInError) {
                console.log('üìù Cr√©ation d\'un compte test...');
                const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
                    email: 'test@teranga.sn',
                    password: 'testpassword123',
                    options: {
                        data: {
                            full_name: 'Utilisateur Test',
                            role: 'Particulier'
                        }
                    }
                });
                
                if (signUpError) {
                    console.error('‚ùå Erreur cr√©ation compte:', signUpError);
                    return;
                } else {
                    console.log('‚úÖ Compte test cr√©√©');
                }
            } else {
                console.log('‚úÖ Connect√© avec succ√®s');
            }
        }

        // R√©cup√©rer l'utilisateur apr√®s connexion
        const { data: currentUser } = await supabase.auth.getUser();
        const userId = currentUser?.user?.id;
        
        if (!userId) {
            console.error('‚ùå Impossible d\'obtenir l\'ID utilisateur');
            return;
        }

        console.log('‚úÖ Utilisateur ID:', userId);

        // 4. Cr√©er des parcelles exemple si n√©cessaire
        console.log('\nüèòÔ∏è √âtape 4: Cr√©ation de parcelles exemple...');
        const { data: parcels, error: parcelsError } = await supabase
            .from('parcels')
            .upsert([
                {
                    id: 'dk-alm-001',
                    name: 'Terrain R√©sidentiel Almadies',
                    description: 'Beau terrain r√©sidentiel pr√®s de la plage',
                    price: 150000000,
                    current_value: 165000000,
                    location: 'Almadies, Dakar',
                    size_sqm: 500,
                    is_available: false
                },
                {
                    id: 'dmn-cit-001',
                    name: 'Terrain P√¥le Urbain Diamniadio',
                    description: 'Terrain dans la nouvelle ville de Diamniadio',
                    price: 25000000,
                    current_value: 28000000,
                    location: 'Diamniadio',
                    size_sqm: 300,
                    is_available: false
                },
                {
                    id: 'slf-ruf-001',
                    name: 'Terrain Commercial Rufisque',
                    description: 'Emplacement strat√©gique pour commerce',
                    price: 45000000,
                    current_value: 48000000,
                    location: 'Rufisque',
                    size_sqm: 800,
                    is_available: true
                }
            ], { onConflict: 'id' })
            .select();

        if (parcelsError) {
            console.error('‚ùå Erreur cr√©ation parcelles:', parcelsError);
        } else {
            console.log('‚úÖ Parcelles cr√©√©es:', parcels?.length || 0);
        }

        // 5. Cr√©er des transactions (investissements)
        console.log('\nüí∞ √âtape 5: Cr√©ation de transactions...');
        const { data: transactions, error: transError } = await supabase
            .from('transactions')
            .upsert([
                {
                    user_id: userId,
                    parcel_id: 'dk-alm-001',
                    amount: 150000000,
                    transaction_type: 'purchase',
                    status: 'completed',
                    payment_method: 'bank_transfer',
                    transaction_date: new Date('2023-01-15').toISOString()
                },
                {
                    user_id: userId,
                    parcel_id: 'dmn-cit-001',
                    amount: 25000000,
                    transaction_type: 'purchase',
                    status: 'completed',
                    payment_method: 'cash',
                    transaction_date: new Date('2024-06-10').toISOString()
                }
            ], { onConflict: 'id' })
            .select();

        if (transError) {
            console.error('‚ùå Erreur cr√©ation transactions:', transError);
        } else {
            console.log('‚úÖ Transactions cr√©√©es:', transactions?.length || 0);
        }

        // 6. Cr√©er des rendez-vous
        console.log('\nüìÖ √âtape 6: Cr√©ation de rendez-vous...');
        const futureDate1 = new Date();
        futureDate1.setDate(futureDate1.getDate() + 12);
        futureDate1.setHours(10, 0, 0);

        const futureDate2 = new Date();
        futureDate2.setDate(futureDate2.getDate() + 17);
        futureDate2.setHours(14, 30, 0);

        const futureDate3 = new Date();
        futureDate3.setDate(futureDate3.getDate() + 27);
        futureDate3.setHours(23, 59, 0);

        const { data: appointments, error: appointError } = await supabase
            .from('appointments')
            .upsert([
                {
                    user_id: userId,
                    parcel_id: 'dk-alm-001',
                    title: 'Visite Terrain Almadies',
                    description: 'Visite sur site du terrain acquis',
                    type: 'visit',
                    scheduled_date: futureDate1.toISOString(),
                    status: 'confirmed',
                    location: 'Almadies, Dakar'
                },
                {
                    user_id: userId,
                    parcel_id: 'slf-ruf-001',
                    title: 'RDV Notaire - Achat Rufisque',
                    description: 'Signature des documents d\'achat',
                    type: 'signing',
                    scheduled_date: futureDate2.toISOString(),
                    status: 'confirmed',
                    location: '√âtude Ma√Ætre Diop'
                },
                {
                    user_id: userId,
                    parcel_id: 'dmn-cit-001',
                    title: 'Paiement √©ch√©ance #2 Diamniadio',
                    description: 'Deuxi√®me √©ch√©ance de paiement',
                    type: 'consultation',
                    scheduled_date: futureDate3.toISOString(),
                    status: 'scheduled'
                }
            ], { onConflict: 'id' })
            .select();

        if (appointError) {
            console.error('‚ùå Erreur cr√©ation rendez-vous:', appointError);
        } else {
            console.log('‚úÖ Rendez-vous cr√©√©s:', appointments?.length || 0);
        }

        // 7. Cr√©er des favoris
        console.log('\n‚ù§Ô∏è √âtape 7: Cr√©ation de favoris...');
        const { data: favorites, error: favError } = await supabase
            .from('favorites')
            .upsert([
                { user_id: userId, parcel_id: 'slf-ruf-001' },
                { user_id: userId, parcel_id: 'dk-alm-001' },
                { user_id: userId, parcel_id: 'dmn-cit-001' }
            ], { onConflict: 'user_id,parcel_id' })
            .select();

        if (favError) {
            console.error('‚ùå Erreur cr√©ation favoris:', favError);
        } else {
            console.log('‚úÖ Favoris cr√©√©s:', favorites?.length || 0);
        }

        // 8. Assigner un agent √† l'utilisateur
        console.log('\nü§ù √âtape 8: Attribution d\'un agent...');
        if (agents && agents.length > 0) {
            const { error: profileUpdateError } = await supabase
                .from('profiles')
                .update({ assigned_agent_id: agents[0].id })
                .eq('id', userId);

            if (profileUpdateError) {
                console.error('‚ùå Erreur attribution agent:', profileUpdateError);
            } else {
                console.log('‚úÖ Agent assign√©:', agents[0].name);
            }
        }

        console.log('\nüéâ DONN√âES R√âELLES CR√â√âES AVEC SUCC√àS !');
        console.log('üìä Le dashboard affichera maintenant des donn√©es r√©elles au lieu de simulations');
        console.log('üîÑ Actualisez votre navigateur pour voir les changements');

    } catch (error) {
        console.error('‚ùå Erreur globale:', error);
    }
}

// Ex√©cuter le script
createRealDashboardData();
