# üîç AUDIT COMPLET - SYST√àME DE PARCELLES VENDEURS

**Date**: 12 Octobre 2025  
**Probl√®mes rapport√©s**:
1. ‚ùå La parcelle ne s'affiche pas sur `/parcelles-vendeurs`
2. ‚ùå Page d'√©dition d'une parcelle ne fonctionne pas
3. ‚ùì Workflow d'achat depuis ParcelleDetailPage pas clair
4. ‚ùì RLS policies bloquent l'affichage

---

## üìã SCOPE DE L'AUDIT

### Pages √† auditer:
1. **`ParcellesVendeursPage.jsx`** - Liste publique des parcelles
2. **`ParcelleDetailPage.jsx`** - D√©tail d'une parcelle + demande d'achat
3. **`VendeurPropertiesRealData.jsx`** - Dashboard vendeur (liste ses biens)
4. **Page d'√©dition** (√† identifier)

### Workflow attendu:
```
[Vendeur cr√©e bien] 
  ‚Üí [Admin approuve] 
  ‚Üí [Bien visible sur /parcelles-vendeurs]
  ‚Üí [Particulier voit d√©tail] 
  ‚Üí [Particulier demande achat]
  ‚Üí [Notif dans dashboard vendeur]
  ‚Üí [Notif dans dashboard particulier]
```

---

## üî¥ PROBL√àME 1: Parcelle invisible sur /parcelles-vendeurs

### Fichier: `src/pages/ParcellesVendeursPage.jsx`

#### ‚ùå Probl√®me d√©tect√©:
**Ligne 99-460**: Utilise des **donn√©es mock√©es en dur** !

```javascript
const parcelles = [
  {
    id: 1,
    title: "Terrain R√©sidentiel - Almadies",
    location: "Almadies, Dakar",
    price: "85 000 000",
    // ... donn√©es en dur
  },
  // ... 14 autres parcelles mock√©es
];
```

**Aucun appel √† Supabase** pour charger les vraies parcelles !

#### ‚úÖ Solution:

```javascript
const [parcelles, setParcelles] = useState([]);
const [loading, setLoading] = useState(true);

useEffect(() => {
  loadParcelles();
}, []);

const loadParcelles = async () => {
  try {
    setLoading(true);
    
    const { data, error } = await supabase
      .from('properties')
      .select(`
        *,
        owner:profiles!owner_id(id, email, full_name),
        photos:property_photos(file_url, is_primary, display_order)
      `)
      .eq('status', 'active')              // Seulement les biens actifs
      .eq('verification_status', 'verified') // Seulement les biens v√©rifi√©s
      .order('created_at', { ascending: false });

    if (error) throw error;

    // Transformer les donn√©es pour correspondre au format attendu
    const formattedData = data.map(prop => ({
      id: prop.id,
      title: prop.title,
      location: `${prop.city}, ${prop.region}`,
      region: prop.region,
      city: prop.city,
      price: prop.price.toLocaleString('fr-FR'),
      surface: prop.surface.toString(),
      type: prop.type,
      seller: prop.owner?.full_name || 'Vendeur',
      sellerName: prop.owner?.full_name,
      sellerId: prop.owner_id,
      sellerType: 'vendeur-particulier',
      image: prop.photos?.find(p => p.is_primary)?.file_url || prop.photos?.[0]?.file_url,
      features: prop.features?.main || [],
      utilities: prop.amenities || [],
      access: prop.features?.access || [],
      rating: 4.5, // TODO: Impl√©menter syst√®me de notation
      views: prop.views_count,
      isFavorite: false, // TODO: Impl√©menter favoris
      isVerified: prop.verification_status === 'verified',
      description: prop.description
    }));

    setParcelles(formattedData);
  } catch (error) {
    console.error('Erreur chargement parcelles:', error);
    toast.error('Impossible de charger les parcelles');
  } finally {
    setLoading(false);
  }
};
```

#### üîß Modifications n√©cessaires:

1. **Import Supabase + useAuth**:
```javascript
import { useAuth } from '@/contexts/AuthContext';
import { toast } from 'sonner';

const ParcellesVendeursPage = () => {
  const { supabase } = useAuth();
  // ...
```

2. **Ajouter √©tat de chargement**:
```jsx
{loading ? (
  <div className="text-center py-20">
    <Loader2 className="h-12 w-12 animate-spin mx-auto text-blue-600" />
    <p className="mt-4 text-gray-600">Chargement des parcelles...</p>
  </div>
) : parcelles.length === 0 ? (
  <div className="text-center py-20">
    <Home className="h-16 w-16 mx-auto text-gray-400 mb-4" />
    <h3 className="text-xl font-semibold text-gray-700">Aucune parcelle disponible</h3>
    <p className="text-gray-500 mt-2">Revenez bient√¥t pour d√©couvrir de nouvelles opportunit√©s</p>
  </div>
) : (
  // ... grid existant
)}
```

---

## üî¥ PROBL√àME 2: Dashboard vendeur (VendeurPropertiesRealData)

### Fichier: `src/pages/dashboards/vendeur/VendeurPropertiesRealData.jsx`

#### ‚úÖ √âtat actuel: **D√âJ√Ä CONNECT√â √Ä SUPABASE** !

**Ligne 60-94**: Utilise Supabase correctement:
```javascript
const loadProperties = async () => {
  const { data, error } = await supabase
    .from('properties')
    .select('*, property_photos(*)')
    .eq('vendor_id', user.id) // ‚ùå ERREUR: devrait √™tre owner_id
    .order('created_at', { ascending: false });
```

#### ‚ùå Probl√®me d√©tect√©:
**Ligne 63**: Utilise `vendor_id` mais la colonne s'appelle `owner_id` !

#### ‚úÖ Solution:
```javascript
.eq('owner_id', user.id)  // Correction
```

#### üîß Autres corrections:

**Ligne 147**: Navigation vers √©dition:
```javascript
onClick={() => navigate(`/dashboard/vendeur/properties/edit/${property.id}`)}
```

V√©rifier que cette route existe dans `App.jsx` / `AppNew.jsx`:
```javascript
<Route path="/dashboard/vendeur/properties/edit/:id" element={<VendeurEditProperty />} />
```

---

## üî¥ PROBL√àME 3: Page d'√©dition manquante

### Recherche de la page d'√©dition:

Aucun fichier trouv√© pour:
- `VendeurEditProperty.jsx`
- `EditPropertyPage.jsx`
- `PropertyEdit.jsx`

#### ‚úÖ Solution: Cr√©er la page d'√©dition

**Fichier √† cr√©er**: `src/pages/dashboards/vendeur/VendeurEditProperty.jsx`

```javascript
import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useAuth } from '@/contexts/AuthContext';
import { toast } from 'sonner';
import { Loader2 } from 'lucide-react';

const VendeurEditProperty = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const { supabase, user } = useAuth();
  const [loading, setLoading] = useState(true);
  const [property, setProperty] = useState(null);
  
  useEffect(() => {
    loadProperty();
  }, [id]);
  
  const loadProperty = async () => {
    try {
      const { data, error } = await supabase
        .from('properties')
        .select('*')
        .eq('id', id)
        .eq('owner_id', user.id) // V√©rifier que c'est bien son bien
        .single();
        
      if (error) throw error;
      
      if (!data) {
        toast.error('Bien non trouv√© ou vous n\'√™tes pas autoris√©');
        navigate('/dashboard/vendeur/properties');
        return;
      }
      
      setProperty(data);
    } catch (error) {
      console.error('Erreur:', error);
      toast.error('Impossible de charger le bien');
    } finally {
      setLoading(false);
    }
  };
  
  const handleSubmit = async (formData) => {
    try {
      const { error } = await supabase
        .from('properties')
        .update(formData)
        .eq('id', id);
        
      if (error) throw error;
      
      toast.success('Bien mis √† jour avec succ√®s');
      navigate('/dashboard/vendeur/properties');
    } catch (error) {
      console.error('Erreur:', error);
      toast.error('Erreur lors de la mise √† jour');
    }
  };
  
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin" />
      </div>
    );
  }
  
  // TODO: R√©utiliser le formulaire de VendeurAddTerrainRealData
  // en mode "√©dition" avec les valeurs pr√©-remplies
  
  return (
    <div>
      <h1>√âditer: {property?.title}</h1>
      {/* Formulaire ici */}
    </div>
  );
};

export default VendeurEditProperty;
```

---

## üî¥ PROBL√àME 4: Workflow demande d'achat

### Fichier: `src/pages/ParcelleDetailPage.jsx`

#### ‚úÖ √âtat actuel:
**Ligne 1050-1150**: Boutons d'action pr√©sents:
```jsx
<Button 
  size="lg" 
  className="flex-1"
  onClick={() => setShowContactModal(true)}
>
  <Phone className="mr-2 h-5 w-5" />
  Contacter le vendeur
</Button>

<Button 
  size="lg" 
  variant="outline" 
  className="flex-1"
  onClick={() => setShowOfferModal(true)}
>
  <FileText className="mr-2 h-5 w-5" />
  Faire une offre
</Button>
```

#### ‚ùå Probl√®mes d√©tect√©s:

1. **Modal "Faire une offre" ne cr√©√© pas d'entr√©e en base**
2. **Pas de notification au vendeur**
3. **Pas de suivi dans dashboard particulier**

#### ‚úÖ Solution: Cr√©er table `property_offers`

```sql
CREATE TABLE property_offers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  property_id UUID REFERENCES properties(id) ON DELETE CASCADE,
  buyer_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  seller_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  offer_price NUMERIC NOT NULL,
  message TEXT,
  status VARCHAR(50) DEFAULT 'pending', -- pending, accepted, rejected, cancelled
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  responded_at TIMESTAMPTZ,
  response_message TEXT
);

-- RLS Policies
ALTER TABLE property_offers ENABLE ROW LEVEL SECURITY;

-- Acheteur peut voir ses propres offres
CREATE POLICY "Buyer_Can_View_Own_Offers" ON property_offers
FOR SELECT USING (auth.uid() = buyer_id);

-- Vendeur peut voir les offres sur ses biens
CREATE POLICY "Seller_Can_View_Offers_On_Properties" ON property_offers
FOR SELECT USING (auth.uid() = seller_id);

-- Acheteur peut cr√©er une offre
CREATE POLICY "Buyer_Can_Create_Offer" ON property_offers
FOR INSERT WITH CHECK (auth.uid() = buyer_id);

-- Vendeur peut mettre √† jour le status
CREATE POLICY "Seller_Can_Update_Offer_Status" ON property_offers
FOR UPDATE USING (auth.uid() = seller_id);
```

#### Modifier `ParcelleDetailPage.jsx`:

```javascript
const handleSubmitOffer = async (offerData) => {
  try {
    // 1. Cr√©er l'offre
    const { data: offer, error: offerError } = await supabase
      .from('property_offers')
      .insert({
        property_id: parcelle.id,
        buyer_id: user.id,
        seller_id: parcelle.owner_id,
        offer_price: offerData.price,
        message: offerData.message
      })
      .select()
      .single();
      
    if (offerError) throw offerError;
    
    // 2. Cr√©er une notification pour le vendeur
    const { error: notifError } = await supabase
      .from('notifications')
      .insert({
        user_id: parcelle.owner_id,
        type: 'new_offer',
        titre: 'Nouvelle offre re√ßue',
        message: `${user.full_name} a fait une offre de ${offerData.price.toLocaleString()} FCFA sur ${parcelle.title}`,
        action_url: `/dashboard/vendeur/offers/${offer.id}`,
        metadata: {
          offer_id: offer.id,
          property_id: parcelle.id,
          buyer_id: user.id
        }
      });
      
    if (notifError) throw notifError;
    
    toast.success('Votre offre a √©t√© envoy√©e au vendeur');
    setShowOfferModal(false);
    
  } catch (error) {
    console.error('Erreur:', error);
    toast.error('Erreur lors de l\'envoi de l\'offre');
  }
};
```

---

## üìä R√âSUM√â DES CORRECTIONS N√âCESSAIRES

### üîß Fixes JavaScript:

| Fichier | Ligne | Probl√®me | Solution |
|---------|-------|----------|----------|
| `ParcellesVendeursPage.jsx` | 99-460 | Donn√©es mock√©es | Remplacer par Supabase query |
| `VendeurPropertiesRealData.jsx` | 63 | `vendor_id` ‚Üí `owner_id` | Corriger nom colonne |
| `ParcelleDetailPage.jsx` | 1100 | Offre ne cr√©√© pas d'entr√©e | Ajouter INSERT dans `property_offers` |
| **√Ä CR√âER** | - | Page √©dition manquante | Cr√©er `VendeurEditProperty.jsx` |

### üóÑÔ∏è Fixes SQL:

```sql
-- 1. Cr√©er table des offres
CREATE TABLE property_offers (...);

-- 2. Ajouter RLS policies
CREATE POLICY ...;

-- 3. V√©rifier que property_photos utilise bien file_url, is_primary, display_order
-- (d√©j√† fait dans les corrections pr√©c√©dentes)
```

### üìÅ Nouveaux fichiers √† cr√©er:

1. **`src/pages/dashboards/vendeur/VendeurEditProperty.jsx`** - Page d'√©dition
2. **`src/pages/dashboards/vendeur/VendeurOffers.jsx`** - Liste des offres re√ßues
3. **`src/pages/dashboards/particulier/ParticulierOffers.jsx`** - Offres envoy√©es

### üîÄ Routes √† ajouter:

```javascript
// Dans App.jsx ou AppNew.jsx
<Route path="/dashboard/vendeur/properties/edit/:id" element={<VendeurEditProperty />} />
<Route path="/dashboard/vendeur/offers" element={<VendeurOffers />} />
<Route path="/dashboard/particulier/offers" element={<ParticulierOffers />} />
```

---

## üéØ PLAN D'ACTION PRIORITAIRE

### Phase 1: Fix affichage parcelles (30 min)
1. ‚úÖ Corriger `ParcellesVendeursPage.jsx` ‚Üí Supabase query
2. ‚úÖ Corriger `VendeurPropertiesRealData.jsx` ‚Üí `owner_id`
3. ‚úÖ Tester avec le bien d'Heritage Fall

### Phase 2: Cr√©er page √©dition (1h)
1. ‚úÖ Cr√©er `VendeurEditProperty.jsx`
2. ‚úÖ Ajouter route dans App
3. ‚úÖ Tester √©dition d'un bien

### Phase 3: Workflow offres (2h)
1. ‚úÖ Cr√©er table `property_offers` (SQL)
2. ‚úÖ Modifier `ParcelleDetailPage.jsx` ‚Üí INSERT offre
3. ‚úÖ Cr√©er `VendeurOffers.jsx` ‚Üí Liste offres
4. ‚úÖ Cr√©er `ParticulierOffers.jsx` ‚Üí Suivi offres
5. ‚úÖ Tester workflow complet

### Phase 4: Polish & Tests (1h)
1. ‚úÖ Ajouter validations
2. ‚úÖ Am√©liorer UX (loading, errors)
3. ‚úÖ Tester RLS policies
4. ‚úÖ Documentation

---

**Temps total estim√©**: ~4-5 heures  
**Priorit√©**: üî¥ URGENT (bloque l'utilisation du site)

---

üìÑ **Document cr√©√© le**: 12 Octobre 2025  
üìù **Par**: GitHub Copilot  
üéØ **Objectif**: D√©bloquer syst√®me de parcelles vendeurs
