# üöÄ FONCTIONNALIT√âS √Ä ACTIVER - Dashboard Notaire

**Date**: 28 Octobre 2025  
**Contexte**: Migrations SQL n√©cessaires pour activer les fonctionnalit√©s bloqu√©es

---

## üî¥ PROBL√àME ACTUEL

Les pages notaire chargent des **donn√©es r√©elles**, mais **certaines fonctionnalit√©s sont BLOQU√âES** par des erreurs SQL :

```
‚ùå PGRST204: column "message_type" does not exist in "purchase_case_messages"
‚ùå 42703: column "appointment_date" does not exist in "calendar_appointments"  
‚ùå RLS: new row violates row-level security policy for table "storage.objects"
```

**Impact**: Les utilisateurs voient les donn√©es, mais ne peuvent pas :
- ‚úâÔ∏è Envoyer de messages
- üìÑ Uploader des documents
- üìÖ Cr√©er des rendez-vous
- üîî Recevoir des notifications temps r√©el

---

## üìã FONCTIONNALIT√âS BLOQU√âES PAR PAGE

### 1. ‚úâÔ∏è NotaireCommunicationModernized.jsx - **BLOQU√âE**

**Route**: `/notaire/communication`

**Fonctionnalit√©s affect√©es**:
- ‚ùå **Envoi de messages tripartites** (Notaire ‚Üí Acheteur/Vendeur/Banque)
  - M√©thode: `NotaireSupabaseService.sendTripartiteMessage()`
  - Erreur: PGRST204 - `message_type` manquant
  - Impact: Bouton "Envoyer" ne fonctionne pas

- ‚ùå **R√©ception de nouveaux messages** (temps r√©el)
  - Service: `RealtimeNotificationService` (ligne 155)
  - Erreur: PGRST204 - Cannot subscribe to `purchase_case_messages`
  - Impact: Pas de notification instantan√©e

**Code bloqu√©**:
```javascript
// Ligne 127 - NotaireCommunicationModernized.jsx
const result = await NotaireSupabaseService.sendTripartiteMessage(user.id, {
  case_id: selectedConversation.id,
  content: newMessage,
  message_type: 'text', // ‚ùå Cette colonne n'existe pas dans la table
  recipients: [selectedConversation.buyer_id, selectedConversation.seller_id]
});
```

**Utilisateurs affect√©s**: 
- Notaires qui veulent coordonner ventes
- Acheteurs/Vendeurs qui attendent r√©ponses

---

### 2. üìÑ NotaireAuthenticationModernized.jsx - **BLOQU√âE**

**Route**: `/notaire/authentication`

**Fonctionnalit√©s affect√©es**:
- ‚ùå **Upload de documents √† authentifier**
  - M√©thode: `supabase.storage.from('documents').upload()`
  - Erreur: RLS Policy Violation
  - Impact: Impossible d'ajouter des documents au dossier

**Code bloqu√©**:
```javascript
// Upload de document pour authentification blockchain
const { data, error } = await supabase.storage
  .from('documents')
  .upload(`notaire/${userId}/${fileName}`, file);
// ‚ùå Erreur: new row violates row-level security policy
```

**Utilisateurs affect√©s**: 
- Notaires qui veulent authentifier actes
- Clients qui attendent certification blockchain

---

### 3. üìÖ NotaireCasesModernized.jsx - **BLOQU√âE**

**Route**: `/notaire/cases`

**Fonctionnalit√©s affect√©es**:
- ‚ùå **Affichage des rendez-vous du dossier**
  - M√©thode: Utilise `calendar_appointments` table
  - Erreur: 42703 - `appointment_date` n'existe pas (c'est `start_time`)
  - Impact: Page crash ou rendez-vous invisibles

- ‚ùå **Cr√©ation de rendez-vous**
  - Erreur: Impossible d'ins√©rer avec mauvaise colonne
  - Impact: Notaire ne peut pas planifier signature

**Code bloqu√©**:
```javascript
// Quelque part dans le code qui charge les rendez-vous
const { data } = await supabase
  .from('calendar_appointments')
  .select('*, appointment_date') // ‚ùå Cette colonne n'existe pas
  .eq('case_id', caseId);
```

**Utilisateurs affect√©s**: 
- Notaires qui planifient signatures
- Acheteurs/Vendeurs qui veulent RDV

---

### 4. üîî NotaireOverviewModernized.jsx - **BLOQU√âE PARTIELLEMENT**

**Route**: `/notaire` (page d'accueil)

**Fonctionnalit√©s affect√©es**:
- ‚ùå **Notifications temps r√©el**
  - Service: `RealtimeNotificationService`
  - Erreur: PGRST204 sur `purchase_case_messages` + 42703 sur `calendar_appointments`
  - Impact: Pas de badge "nouveaux messages" en temps r√©el

**Code bloqu√©**:
```javascript
// RealtimeNotificationService.js ligne 155-240
supabase
  .channel('notaire-updates')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'purchase_case_messages', // ‚ùå Erreur PGRST204
    filter: `recipient_id=eq.${userId}`
  }, handleNewMessage)
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'calendar_appointments', // ‚ùå Erreur 42703
    filter: `notaire_id=eq.${userId}`
  }, handleNewAppointment)
  .subscribe();
```

**Utilisateurs affect√©s**: 
- Tous les notaires (pas de notifications instantan√©es)

---

### 5. üìä NotaireAnalyticsModernized.jsx - **FONCTIONNE**

**Route**: `/notaire/analytics`

‚úÖ **Aucune fonctionnalit√© bloqu√©e** - Utilise uniquement `notarial_acts` et analytics tables

---

### 6. üìÅ NotaireArchivesModernized.jsx - **FONCTIONNE**

**Route**: `/notaire/archives`

‚úÖ **Aucune fonctionnalit√© bloqu√©e** - Lecture seule sur `notarial_acts`

---

### 7. ‚öñÔ∏è NotaireComplianceModernized.jsx - **FONCTIONNE**

**Route**: `/notaire/compliance`

‚úÖ **Aucune fonctionnalit√© bloqu√©e** - Utilise `compliance_checks`

---

### 8. ü§ñ NotaireAIModernized.jsx - **FONCTIONNE**

**Route**: `/notaire/ai`

‚úÖ **Fonctionnalit√©s actives** - Chat IA local (pas de d√©pendance SQL bloquante)

---

### 9. üîó NotaireBlockchainModernized.jsx - **BLOQU√âE PARTIELLEMENT**

**Route**: `/notaire/blockchain`

**Fonctionnalit√©s affect√©es**:
- ‚ö†Ô∏è **Authentification de documents** (m√™me probl√®me que Authentication page)
  - Upload bloqu√© par RLS storage
  - Authentification fonctionne SI document d√©j√† upload√©

---

### 10. üë• NotaireCRMModernized.jsx - **FONCTIONNE**

**Route**: `/notaire/crm`

‚úÖ **Aucune fonctionnalit√© bloqu√©e** - Utilise `notaire_clients`, `banking_partners`

---

### 11. üí∞ NotaireTransactionsModernized.jsx - **FONCTIONNE**

**Route**: `/notaire/transactions`

‚úÖ **Aucune fonctionnalit√© bloqu√©e** - Lecture sur `notarial_acts`

---

### 12. ‚öôÔ∏è NotaireSettingsModernized.jsx - **FONCTIONNE**

**Route**: `/notaire/settings`

‚úÖ **Aucune fonctionnalit√© bloqu√©e** - Utilise `profiles`

---

## üìä R√âSUM√â DES IMPACTS

| Fonctionnalit√© | Status | Pages Affect√©es | Utilisateurs Impact√©s |
|----------------|--------|-----------------|----------------------|
| **Envoi messages tripartites** | ‚ùå BLOQU√â | Communication | Notaires, Acheteurs, Vendeurs |
| **Notifications temps r√©el** | ‚ùå BLOQU√â | Overview + toutes | Tous les notaires |
| **Upload documents** | ‚ùå BLOQU√â | Authentication, Blockchain | Notaires |
| **Rendez-vous** | ‚ùå BLOQU√â | Cases | Notaires, Clients |
| **Analytics** | ‚úÖ FONCTIONNE | Analytics | - |
| **CRM** | ‚úÖ FONCTIONNE | CRM | - |
| **Archives** | ‚úÖ FONCTIONNE | Archives | - |
| **Transactions** | ‚úÖ FONCTIONNE | Transactions | - |

---

## üîß SOLUTIONS SQL √Ä APPLIQUER

### Solution 1: QUICK_FIX_CALENDAR_APPOINTMENTS.sql

**Fichier**: `QUICK_FIX_CALENDAR_APPOINTMENTS.sql`

**Fixes**:
```sql
-- 1. Ajouter message_type √† purchase_case_messages
ALTER TABLE purchase_case_messages 
ADD COLUMN IF NOT EXISTS message_type VARCHAR(50) DEFAULT 'text';

-- 2. Cr√©er index sur message_type
CREATE INDEX IF NOT EXISTS idx_purchase_case_messages_type 
ON purchase_case_messages(message_type);

-- 3. Cr√©er purchase_case_documents SI manquant
CREATE TABLE IF NOT EXISTS purchase_case_documents (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  case_id UUID REFERENCES purchase_requests(id) ON DELETE CASCADE,
  uploaded_by UUID REFERENCES auth.users(id),
  document_name VARCHAR(255) NOT NULL,
  document_url TEXT NOT NULL,
  document_type VARCHAR(100),
  file_size INTEGER,
  uploaded_at TIMESTAMP DEFAULT NOW()
);
```

**Fonctionnalit√©s activ√©es**:
- ‚úÖ Envoi de messages tripartites
- ‚úÖ Notifications temps r√©el messages
- ‚úÖ Upload de documents dossiers

---

### Solution 2: FIX_RLS_POLICIES.sql

**Fichier**: `FIX_RLS_POLICIES.sql`

**Fixes**:
```sql
-- 1. Enable RLS sur purchase_case_messages
ALTER TABLE purchase_case_messages ENABLE ROW LEVEL SECURITY;

-- 2. Policies pour messages (Acheteur/Vendeur/Notaire)
CREATE POLICY "Users can view their messages"
ON purchase_case_messages FOR SELECT
USING (
  auth.uid() IN (sender_id, receiver_id) OR
  auth.uid() IN (
    SELECT buyer_id FROM purchase_requests WHERE id = case_id
    UNION
    SELECT seller_id FROM purchase_requests WHERE id = case_id
    UNION
    SELECT notaire_id FROM purchase_requests WHERE id = case_id
  )
);

-- 3. Policy pour storage documents
CREATE POLICY "Authenticated users can upload documents"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'documents' AND
  auth.role() = 'authenticated'
);
```

**Fonctionnalit√©s activ√©es**:
- ‚úÖ S√©curit√© messages tripartites
- ‚úÖ Upload documents s√©curis√©
- ‚úÖ Acc√®s contr√¥l√© par r√¥le

---

### Solution 3: Storage Bucket Configuration (Manuel)

**√âtapes dans Supabase Dashboard**:

1. **Aller dans Storage** ‚Üí S√©lectionner bucket `documents`
2. **Configuration**:
   - ‚úÖ Public: `false` (priv√©)
   - ‚úÖ File size limit: `50 MB`
   - ‚úÖ Allowed MIME types: `application/pdf, image/*, application/msword, application/vnd.openxmlformats-officedocument.*`
3. **Policies** ‚Üí Add policy:
   ```sql
   CREATE POLICY "Authenticated upload"
   ON storage.objects FOR INSERT
   WITH CHECK (
     bucket_id = 'documents' AND
     auth.role() = 'authenticated'
   );
   ```

**Fonctionnalit√©s activ√©es**:
- ‚úÖ Upload documents authentification blockchain
- ‚úÖ Upload pi√®ces justificatives dossiers

---

## ‚úÖ CHECKLIST D'ACTIVATION

### √âtape 1: Ex√©cuter les migrations SQL (10 min)

- [ ] Ouvrir Supabase Console (https://supabase.com)
- [ ] Aller dans SQL Editor
- [ ] **Changer le r√¥le en `service_role`** (important !)
- [ ] Copier/coller `QUICK_FIX_CALENDAR_APPOINTMENTS.sql`
- [ ] Ex√©cuter ‚Üí V√©rifier "Success"
- [ ] Copier/coller `FIX_RLS_POLICIES.sql`
- [ ] Ex√©cuter ‚Üí V√©rifier "Success"

### √âtape 2: Configurer Storage (5 min)

- [ ] Aller dans Storage ‚Üí `documents` bucket
- [ ] Policies ‚Üí Add policy (INSERT pour authenticated)
- [ ] Sauvegarder

### √âtape 3: Tests des fonctionnalit√©s (15 min)

#### Test 1: Messages ‚úâÔ∏è
- [ ] Aller sur `/notaire/communication`
- [ ] S√©lectionner une conversation
- [ ] √âcrire un message
- [ ] Cliquer "Envoyer"
- [ ] **Attendu**: Message envoy√© sans erreur PGRST204

#### Test 2: Documents üìÑ
- [ ] Aller sur `/notaire/authentication`
- [ ] Cliquer "Upload Document"
- [ ] S√©lectionner un PDF
- [ ] Upload
- [ ] **Attendu**: Upload r√©ussi sans erreur RLS

#### Test 3: Rendez-vous üìÖ
- [ ] Aller sur `/notaire/cases`
- [ ] Ouvrir un dossier
- [ ] Voir la section rendez-vous
- [ ] **Attendu**: Pas de crash, rendez-vous affich√©s

#### Test 4: Notifications üîî
- [ ] Ouvrir 2 navigateurs (Notaire + Acheteur)
- [ ] Acheteur envoie message
- [ ] **Attendu**: Notaire re√ßoit notification instantan√©e

---

## üöÄ APR√àS ACTIVATION

### Fonctionnalit√©s qui seront actives:

‚úÖ **Communication tripartite compl√®te**
- Messages instantan√©s Notaire ‚Üî Acheteur ‚Üî Vendeur ‚Üî Banque
- Notifications temps r√©el
- Historique complet des conversations

‚úÖ **Gestion documentaire**
- Upload documents (PDF, Word, Images)
- Authentification blockchain
- Stockage s√©curis√©

‚úÖ **Planification rendez-vous**
- Cr√©er RDV signature
- Notifications rappel
- Synchronisation calendrier

‚úÖ **Notifications temps r√©el**
- Badge "nouveaux messages"
- Alerte nouveaux dossiers
- Rappels rendez-vous

---

## üìà M√âTRIQUES DE SUCC√àS

Apr√®s activation, v√©rifier:

- **Taux d'envoi messages**: Devrait passer de 0% √† ~90%
- **Documents upload√©s**: Devrait augmenter (actuellement 0)
- **Rendez-vous cr√©√©s**: Devrait augmenter
- **Engagement utilisateurs**: +50% temps pass√© sur plateforme

---

## üÜò TROUBLESHOOTING

### Erreur persiste apr√®s migration?

1. **V√©rifier r√¥le SQL**:
   ```sql
   -- Dans SQL Editor, v√©rifier en haut √† droite:
   -- Doit √™tre "service_role" (PAS "anon" ou "authenticated")
   ```

2. **V√©rifier colonnes cr√©√©es**:
   ```sql
   SELECT column_name, data_type 
   FROM information_schema.columns 
   WHERE table_name = 'purchase_case_messages' 
   AND column_name = 'message_type';
   -- Doit retourner 1 ligne
   ```

3. **V√©rifier RLS policies**:
   ```sql
   SELECT * FROM pg_policies 
   WHERE tablename = 'purchase_case_messages';
   -- Doit retourner 3 policies (SELECT, INSERT, UPDATE)
   ```

4. **V√©rifier storage policy**:
   - Aller dans Storage ‚Üí documents ‚Üí Policies
   - Doit voir policy "Authenticated upload" ou similaire

---

## üìû BESOIN D'AIDE?

**Documentation compl√®te**: `GUIDE_EXECUTION_FIXES_CRITIQUES.md`

**R√©sum√© visuel**: `RESUME_FIXES_SQL_CRITIQUES.txt`

**Support technique**: Cr√©er ticket dans NotaireSupportPage

---

**Temps d'activation total**: ~30 minutes  
**Complexit√©**: ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ (Facile - Copier/coller SQL)  
**Impact**: üöÄüöÄüöÄüöÄüöÄ (Critique - D√©bloque 4 fonctionnalit√©s majeures)

---

**Derni√®re mise √† jour**: 28 Octobre 2025  
**Version**: 1.0  
**Status**: ‚è≥ EN ATTENTE D'EX√âCUTION
